name: Build and Release

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-unit-test:
    name: Build & Unit Tests (macOS ARM64)
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Download Capstone
        run: |
          curl -sL https://github.com/capstone-engine/capstone/archive/refs/tags/6.0.0-Alpha6.tar.gz | tar xz
          mv capstone-6.0.0-Alpha6 capstone

      - name: Build FasterBASIC (ReleaseFast)
        run: |
          cd zig_compiler
          zig build -Doptimize=ReleaseFast

      - name: Verify build
        run: |
          file zig_compiler/zig-out/bin/fbc
          zig_compiler/zig-out/bin/fbc --version

      - name: Run unit tests
        run: |
          cd zig_compiler
          zig build test

      - name: Upload fbc binary
        uses: actions/upload-artifact@v4
        with:
          name: fbc-binary
          path: zig_compiler/zig-out/bin/fbc
          retention-days: 7

  jit-tests:
    name: JIT Tests
    runs-on: macos-14
    needs: [build-and-unit-test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download fbc binary
        uses: actions/download-artifact@v4
        with:
          name: fbc-binary
          path: bin

      - name: Make fbc executable
        run: chmod +x bin/fbc

      - name: Install coreutils (for timeout)
        run: brew install --quiet coreutils

      - name: Run JIT batch tests (batch_test suite)
        run: |
          echo "============================================"
          echo " JIT Batch Tests — batch_test suite"
          echo "============================================"
          bin/fbc --batch-jit zig_compiler/tests/batch_test --timeout 30
          echo ""

      - name: Run JIT smoke tests
        run: |
          echo "============================================"
          echo " JIT Smoke Tests"
          echo "============================================"
          TOTAL=0
          PASSED=0
          FAILED=0
          FAILED_TESTS=""

          for f in zig_compiler/tests/jit_*.bas; do
            [ -f "$f" ] || continue
            test_name="$(basename "$f" .bas)"
            TOTAL=$((TOTAL + 1))

            if output=$(gtimeout 30 bin/fbc --jit "$f" 2>&1); then
              PASSED=$((PASSED + 1))
              echo "PASS  $test_name"
            else
              rc=$?
              if [ $rc -eq 124 ]; then
                FAILED=$((FAILED + 1))
                FAILED_TESTS="$FAILED_TESTS  $test_name (timeout)\n"
                echo "FAIL  $test_name (timeout)"
              else
                FAILED=$((FAILED + 1))
                FAILED_TESTS="$FAILED_TESTS  $test_name (exit $rc)\n"
                echo "FAIL  $test_name (exit $rc)"
                echo "  output: $output"
              fi
            fi
          done

          echo ""
          echo "============================================"
          echo " JIT Smoke Results: $PASSED/$TOTAL passed"
          echo "============================================"

          if [ "$FAILED" -gt 0 ]; then
            echo ""
            echo "Failed tests:"
            echo -e "$FAILED_TESTS"
            exit 1
          fi

      - name: Run JIT tests on main test suite (informational)
        run: |
          echo "============================================"
          echo " JIT — Main Test Suite (best-effort)"
          echo "============================================"
          echo ""
          echo "Running with --timeout 10 and no --fail-fast"
          echo "Some tests may not yet work under JIT."
          echo ""
          # Informational only — don't fail the build
          bin/fbc --batch-jit tests --timeout 10 2>&1 || true

  aot-tests:
    name: AOT End-to-End Tests
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install coreutils (for timeout)
        run: brew install --quiet coreutils

      - name: Download Capstone
        run: |
          curl -sL https://github.com/capstone-engine/capstone/archive/refs/tags/6.0.0-Alpha6.tar.gz | tar xz
          mv capstone-6.0.0-Alpha6 capstone

      - name: Build FasterBASIC
        run: |
          cd zig_compiler
          zig build -Doptimize=ReleaseFast

      - name: Verify AOT compilation works
        run: |
          cat > /tmp/test_hello.bas << 'EOF'
          PRINT "Hello from FasterBASIC!"
          END
          EOF
          ./zig_compiler/zig-out/bin/fbc /tmp/test_hello.bas -o /tmp/test_hello
          /tmp/test_hello

      - name: Run AOT test suite
        run: |
          echo "============================================"
          echo " AOT End-to-End Tests"
          echo "============================================"

          FBC="$(pwd)/zig_compiler/zig-out/bin/fbc"
          TOTAL=0
          PASSED=0
          FAILED=0
          SKIPPED=0
          FAILED_TESTS=""

          for bas_file in $(find tests -name '*.bas' -type f | sort); do
            test_name=$(echo "$bas_file" | sed 's|^tests/||; s|\.bas$||; s|/|__|g')
            TOTAL=$((TOTAL + 1))

            out_exe="/tmp/fbc_aot_${test_name}"

            # Compile
            if ! $FBC "$bas_file" -o "$out_exe" 2>/tmp/fbc_compile_err.txt; then
              FAILED=$((FAILED + 1))
              hint=$(head -1 /tmp/fbc_compile_err.txt 2>/dev/null)
              FAILED_TESTS="$FAILED_TESTS  COMPILE: $test_name — $hint\n"
              echo "FAIL [compile] $test_name"
              rm -f "$out_exe"
              continue
            fi

            # Run
            if [ ! -x "$out_exe" ]; then
              FAILED=$((FAILED + 1))
              FAILED_TESTS="$FAILED_TESTS  NO_EXE: $test_name\n"
              echo "FAIL [no exe]  $test_name"
              continue
            fi

            if output=$(gtimeout 15 "$out_exe" 2>&1); then
              PASSED=$((PASSED + 1))
              echo "PASS           $test_name"
            else
              rc=$?
              if [ $rc -eq 124 ]; then
                FAILED=$((FAILED + 1))
                FAILED_TESTS="$FAILED_TESTS  TIMEOUT: $test_name\n"
                echo "FAIL [timeout] $test_name"
              elif [ $rc -gt 128 ]; then
                sig=$((rc - 128))
                FAILED=$((FAILED + 1))
                FAILED_TESTS="$FAILED_TESTS  SIGNAL: $test_name (sig $sig)\n"
                echo "FAIL [sig $sig] $test_name"
              else
                # Non-zero exit is acceptable for some tests (error handling, etc.)
                PASSED=$((PASSED + 1))
                echo "PASS           $test_name (exit $rc)"
              fi
            fi
            rm -f "$out_exe"
          done

          echo ""
          echo "============================================"
          echo " AOT Results: $PASSED/$TOTAL passed"
          echo "============================================"

          if [ "$FAILED" -gt 0 ]; then
            echo ""
            echo "Failed tests:"
            echo -e "$FAILED_TESTS"
          fi

          # Fail if less than 80% pass
          if [ "$TOTAL" -gt 0 ]; then
            PASS_RATE=$((PASSED * 100 / TOTAL))
            echo "Pass rate: ${PASSED}/${TOTAL} (${PASS_RATE}%)"
            if [ "$PASS_RATE" -lt 80 ]; then
              echo "ERROR: Pass rate below 80% threshold"
              exit 1
            fi
          fi

  neon-tests:
    name: NEON & Array Expression Tests
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install coreutils (for timeout)
        run: brew install --quiet coreutils

      - name: Download Capstone
        run: |
          curl -sL https://github.com/capstone-engine/capstone/archive/refs/tags/6.0.0-Alpha6.tar.gz | tar xz
          mv capstone-6.0.0-Alpha6 capstone

      - name: Build FasterBASIC
        run: |
          cd zig_compiler
          zig build -Doptimize=ReleaseFast

      - name: Run NEON-path tests
        env:
          ENABLE_NEON_LOOP: "1"
        run: |
          FBC="$(pwd)/zig_compiler/zig-out/bin/fbc"
          TOTAL=0
          PASSED=0
          FAILED=0
          FAILED_TESTS=""

          run_suite() {
            local suite_name="$1"
            local suite_dir="$2"

            echo ""
            echo "============================================"
            echo "  $suite_name — NEON Enabled"
            echo "============================================"
            echo ""

            for bas_file in "$suite_dir"/*.bas; do
              [ -f "$bas_file" ] || continue
              test_name="$(basename "$bas_file" .bas)"
              TOTAL=$((TOTAL + 1))

              if ! $FBC "$bas_file" -o "/tmp/neon_${test_name}" 2>&1; then
                echo "FAIL [compile] $test_name"
                FAILED=$((FAILED + 1))
                FAILED_TESTS="$FAILED_TESTS  COMPILE: $test_name\n"
                continue
              fi

              output=$(gtimeout 15 "/tmp/neon_${test_name}" 2>&1) || true

              fail_count=$(echo "$output" | grep -ci "FAIL" || true)
              if [ "$fail_count" -gt 0 ]; then
                echo "FAIL [runtime] $test_name ($fail_count failure(s))"
                FAILED=$((FAILED + 1))
                FAILED_TESTS="$FAILED_TESTS  RUNTIME: $test_name ($fail_count failures)\n"
              else
                pass_count=$(echo "$output" | grep -ci "PASS" || true)
                if [ "$pass_count" -eq 0 ]; then
                  echo "FAIL [no PASS] $test_name"
                  FAILED=$((FAILED + 1))
                  FAILED_TESTS="$FAILED_TESTS  NO_PASS: $test_name\n"
                else
                  echo "PASS           $test_name"
                  PASSED=$((PASSED + 1))
                fi
              fi
              rm -f "/tmp/neon_${test_name}"
            done
          }

          run_suite "Array Expression Tests" "tests/array_expr"
          run_suite "NEON SIMD Tests"        "tests/neon"

          echo ""
          echo "============================================"
          echo "  NEON Results: $PASSED/$TOTAL passed"
          echo "============================================"

          if [ "$FAILED" -gt 0 ]; then
            echo ""
            echo "Failed tests:"
            echo -e "$FAILED_TESTS"
            exit 1
          fi

  package:
    name: Package Release
    runs-on: macos-14
    needs: [build-and-unit-test, jit-tests, aot-tests, neon-tests]
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download fbc binary
        uses: actions/download-artifact@v4
        with:
          name: fbc-binary
          path: bin

      - name: Make fbc executable
        run: chmod +x bin/fbc

      - name: Package release archive
        run: |
          mkdir -p release/fasterbasic-macos-arm64
          cp bin/fbc release/fasterbasic-macos-arm64/
          cp README.md release/fasterbasic-macos-arm64/
          cp LICENSE release/fasterbasic-macos-arm64/ || echo "No LICENSE file"

          # Include example programs
          mkdir -p release/fasterbasic-macos-arm64/examples
          cp examples/*.bas release/fasterbasic-macos-arm64/examples/ 2>/dev/null || true

          cat > release/fasterbasic-macos-arm64/QUICKSTART.md << 'QUICKSTART'
          # FasterBASIC — Quick Start

          ## JIT Mode (no external toolchain needed)

              ./fbc --jit hello.bas
              ./fbc --run hello.bas

          ## Compile and Run (AOT — requires clang/cc)

              ./fbc hello.bas -o hello
              ./hello

          ## Options

              ./fbc program.bas -o name          # Compile to native executable
              ./fbc --jit program.bas             # JIT compile and run in-process
              ./fbc --run program.bas arg1 arg2   # JIT run with program arguments
              ./fbc --jit-verbose program.bas     # JIT with full disassembly report
              ./fbc --metrics program.bas         # Show phase timings after JIT run
              ./fbc program.bas -i -o out.qbe     # Emit QBE IL only
              ./fbc program.bas -c -o out.s       # Emit assembly only

          ## Documentation

              https://github.com/albanread/FasterBASIC
          QUICKSTART

          cd release
          tar -czf fasterbasic-macos-arm64.tar.gz fasterbasic-macos-arm64

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: fasterbasic-macos-arm64
          path: release/fasterbasic-macos-arm64.tar.gz
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [package]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release artifact
        uses: actions/download-artifact@v4
        with:
          name: fasterbasic-macos-arm64
          path: artifacts

      - name: Create release notes
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          cat > RELEASE_NOTES.md << EOF
          # FasterBASIC v${VERSION}

          ## Downloads

          - **macOS ARM64** (Apple Silicon M1/M2/M3/M4): \`fasterbasic-macos-arm64.tar.gz\`

          ## What's New

          ### JIT Compiler (ARM64)
          - In-memory compilation and execution — no external assembler or linker needed
          - All control flow: IF/ELSE, FOR, WHILE, DO/LOOP, SELECT CASE, GOSUB/RETURN
          - User-defined FUNCTION/SUB with recursion
          - String operations, hashmaps, math functions
          - 200+ real runtime functions wired via jump table
          - Annotated Capstone disassembly with \`--jit-verbose\`
          - Batch test harness with \`--batch-jit\`
          - Phase timings with \`--metrics\`

          ### AOT Compiler
          - Native executable generation via QBE backend + clang
          - Same compiler pipeline — only the final stage differs
          - 300+ ARM64 encoder functions, 828 clang-verified cases

          ### Language Features
          - Workers & concurrency with MARSHALL/UNMARSHALL
          - Object-oriented programming (classes, inheritance, polymorphism)
          - Collections: Lists, HashMaps, dynamic arrays
          - Pattern matching with MATCH TYPE
          - Exception handling (TRY/CATCH/FINALLY)
          - NEON SIMD acceleration for array expressions
          - Scope-Aware Memory Manager (SAMM)
          - Full terminal I/O (cursor, color, keyboard, mouse)

          ## Installation

          \`\`\`bash
          tar -xzf fasterbasic-macos-arm64.tar.gz
          cd fasterbasic-macos-arm64
          ./fbc --jit hello.bas       # JIT mode (no toolchain needed)
          ./fbc hello.bas -o hello    # AOT mode (needs clang/cc)
          \`\`\`

          ## Building from Source

          \`\`\`bash
          git clone https://github.com/albanread/FasterBASIC.git
          cd FasterBASIC/zig_compiler
          zig build -Doptimize=ReleaseFast
          \`\`\`

          Requires Zig 0.15.x.

          ## Documentation

          - [README](https://github.com/albanread/FasterBASIC/blob/main/README.md)
          - [Language Quick Reference](https://github.com/albanread/FasterBASIC/blob/main/docs/FasterBASIC_QuickRef.md)
          - [Language Summary](https://github.com/albanread/FasterBASIC/blob/main/docs/FasterBASIC_Language_Summary.md)
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/fasterbasic-macos-arm64.tar.gz
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
