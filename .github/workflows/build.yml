name: Build and Release

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-macos:
    name: Build macOS ARM64
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Build FasterBASIC
        run: |
          cd zig_compiler
          zig build

      - name: Verify build
        run: |
          file zig_compiler/zig-out/bin/fbc

      - name: Create test program
        run: |
          cat > test_hello.bas << 'EOF'
          PRINT "Hello from FasterBASIC!"
          PRINT "Platform: macOS ARM64"
          END
          EOF

      - name: Test compilation
        run: |
          ./zig_compiler/zig-out/bin/fbc test_hello.bas -o test_hello
          ./test_hello

      - name: Run full test suite
        run: |
          bash run_tests_parallel.sh

      - name: Package release
        run: |
          mkdir -p release/fasterbasic-macos-arm64
          cp zig_compiler/zig-out/bin/fbc release/fasterbasic-macos-arm64/
          cp README.md release/fasterbasic-macos-arm64/
          cp LICENSE release/fasterbasic-macos-arm64/ || echo "No LICENSE file"

          cat > release/fasterbasic-macos-arm64/README.txt << 'EOF'
          FasterBASIC Compiler - macOS ARM64 (Apple Silicon)
          ==================================================

          Usage:
            ./fbc program.bas -o name          # Compile to executable
            ./fbc program.bas -i -o out.qbe    # Generate QBE IL
            ./fbc program.bas -c -o out.s      # Generate assembly

          Documentation:
            https://github.com/albanread/FasterBASIC/wiki

          Examples:
            echo 'PRINT "Hello, World!"' > hello.bas
            echo 'END' >> hello.bas
            ./fbc hello.bas -o hello
            ./hello
          EOF

          cd release
          tar -czf fasterbasic-macos-arm64.tar.gz fasterbasic-macos-arm64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fasterbasic-macos-arm64
          path: release/fasterbasic-macos-arm64.tar.gz
          retention-days: 90

  test-neon:
    name: NEON Tests (array_expr + neon)
    runs-on: macos-latest
    needs: [build-macos]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Build FasterBASIC
        run: |
          cd zig_compiler
          zig build

      - name: Run all NEON-path tests
        env:
          ENABLE_NEON_LOOP: "1"
        run: |
          FBC="./zig_compiler/zig-out/bin/fbc"
          TOTAL=0
          PASSED=0
          FAILED=0
          FAILED_TESTS=""

          run_suite() {
            local suite_name="$1"
            local suite_dir="$2"

            echo ""
            echo "============================================"
            echo "  $suite_name — NEON Enabled"
            echo "============================================"
            echo ""

            for bas_file in "$suite_dir"/*.bas; do
              [ -f "$bas_file" ] || continue
              test_name="$(basename "$bas_file" .bas)"
              echo "--- Compiling: $test_name ---"
              TOTAL=$((TOTAL + 1))

              if ! $FBC "$bas_file" -o "test_output_${test_name}" 2>&1; then
                echo "COMPILE ERROR: $test_name"
                FAILED=$((FAILED + 1))
                FAILED_TESTS="$FAILED_TESTS  COMPILE: $test_name\n"
                continue
              fi

              echo "--- Running: $test_name ---"
              output=$("./test_output_${test_name}" 2>&1) || true
              echo "$output"
              echo ""

              fail_count=$(echo "$output" | grep -ci "FAIL" || true)
              if [ "$fail_count" -gt 0 ]; then
                echo "*** TEST FAILED: $test_name ($fail_count failure(s)) ***"
                FAILED=$((FAILED + 1))
                FAILED_TESTS="$FAILED_TESTS  RUNTIME: $test_name ($fail_count failures)\n"
              else
                pass_count=$(echo "$output" | grep -ci "PASS" || true)
                if [ "$pass_count" -eq 0 ]; then
                  echo "*** TEST SUSPECT: $test_name (no PASS lines found) ***"
                  FAILED=$((FAILED + 1))
                  FAILED_TESTS="$FAILED_TESTS  NO_PASS: $test_name\n"
                else
                  PASSED=$((PASSED + 1))
                fi
              fi

              rm -f "./test_output_${test_name}"
            done
          }

          run_suite "Array Expression Tests" "tests/array_expr"
          run_suite "NEON SIMD Tests"        "tests/neon"

          echo ""
          echo "============================================"
          echo "  NEON Results: $PASSED/$TOTAL passed"
          echo "============================================"

          if [ "$FAILED" -gt 0 ]; then
            echo ""
            echo "Failed tests:"
            echo -e "$FAILED_TESTS"
            exit 1
          fi

  test-scalar:
    name: Scalar Fallback Tests (array_expr + neon)
    runs-on: macos-latest
    needs: [build-macos]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Build FasterBASIC
        run: |
          cd zig_compiler
          zig build

      - name: Run all scalar-fallback tests
        env:
          ENABLE_NEON_LOOP: "0"
        run: |
          FBC="./zig_compiler/zig-out/bin/fbc"
          TOTAL=0
          PASSED=0
          FAILED=0
          FAILED_TESTS=""

          run_suite() {
            local suite_name="$1"
            local suite_dir="$2"

            echo ""
            echo "============================================"
            echo "  $suite_name — Scalar Fallback"
            echo "============================================"
            echo ""

            for bas_file in "$suite_dir"/*.bas; do
              [ -f "$bas_file" ] || continue
              test_name="$(basename "$bas_file" .bas)"
              echo "--- Compiling: $test_name ---"
              TOTAL=$((TOTAL + 1))

              if ! $FBC "$bas_file" -o "test_output_${test_name}_scalar" 2>&1; then
                echo "COMPILE ERROR: $test_name"
                FAILED=$((FAILED + 1))
                FAILED_TESTS="$FAILED_TESTS  COMPILE: $test_name\n"
                continue
              fi

              echo "--- Running: $test_name (scalar) ---"
              output=$(ENABLE_NEON_LOOP=0 "./test_output_${test_name}_scalar" 2>&1) || true
              echo "$output"
              echo ""

              fail_count=$(echo "$output" | grep -ci "FAIL" || true)
              if [ "$fail_count" -gt 0 ]; then
                echo "*** TEST FAILED: $test_name ($fail_count failure(s)) ***"
                FAILED=$((FAILED + 1))
                FAILED_TESTS="$FAILED_TESTS  RUNTIME: $test_name ($fail_count failures)\n"
              else
                pass_count=$(echo "$output" | grep -ci "PASS" || true)
                if [ "$pass_count" -eq 0 ]; then
                  echo "*** TEST SUSPECT: $test_name (no PASS lines found) ***"
                  FAILED=$((FAILED + 1))
                  FAILED_TESTS="$FAILED_TESTS  NO_PASS: $test_name\n"
                else
                  PASSED=$((PASSED + 1))
                fi
              fi

              rm -f "./test_output_${test_name}_scalar"
            done
          }

          run_suite "Array Expression Tests" "tests/array_expr"
          run_suite "NEON SIMD Tests"        "tests/neon"

          echo ""
          echo "============================================"
          echo "  Scalar Fallback Results: $PASSED/$TOTAL passed"
          echo "============================================"

          if [ "$FAILED" -gt 0 ]; then
            echo ""
            echo "Failed tests:"
            echo -e "$FAILED_TESTS"
            exit 1
          fi

  create-release:
    name: Create GitHub Release
    needs: [build-macos, test-neon, test-scalar]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # FasterBASIC Release

          ## Downloads

          - **macOS ARM64** (Apple Silicon M1/M2/M3): `fasterbasic-macos-arm64.tar.gz`

          ## Installation

          1. Download the archive
          2. Extract: `tar -xzf fasterbasic-macos-arm64.tar.gz`
          3. Run: `cd fasterbasic-macos-arm64/ && ./fbc yourprogram.bas -o yourprogram`

          ## Building from Source

          ```bash
          git clone https://github.com/albanread/FasterBASIC.git
          cd FasterBASIC/zig_compiler
          zig build
          ```

          ## Documentation

          Visit the [FasterBASIC Wiki](https://github.com/albanread/FasterBASIC/wiki) for:
          - [Quick Reference](https://github.com/albanread/FasterBASIC/wiki/Quick-Reference)
          - [Language Summary](https://github.com/albanread/FasterBASIC/wiki/Language-Summary)
          - [Classes and Objects](https://github.com/albanread/FasterBASIC/wiki/Classes-and-Objects)
          - [Lists and Pattern Matching](https://github.com/albanread/FasterBASIC/wiki/Lists-and-Pattern-Matching)
          - [NEON SIMD Support](https://github.com/albanread/FasterBASIC/wiki/NEON-SIMD-Support)

          ## Quick Start

          ```bash
          echo 'PRINT "Hello, FasterBASIC!"' > hello.bas
          echo 'END' >> hello.bas
          ./fbc hello.bas -o hello
          ./hello
          ```

          ## Features

          - Compiler written in Zig with hybrid Zig + C runtime
          - Native code compilation via QBE backend
          - Workers with MARSHALL/UNMARSHALL for concurrency
          - Object-oriented programming (classes, inheritance, polymorphism)
          - Modern collections (Lists, HashMaps)
          - Pattern matching with MATCH TYPE
          - Exception handling (TRY/CATCH/FINALLY)
          - NEON SIMD acceleration on ARM64
          - Whole-array expressions with automatic NEON vectorization
          - Plugin system for extensibility
          - 312 end-to-end tests

          For more information, visit: https://github.com/albanread/FasterBASIC
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/fasterbasic-macos-arm64/fasterbasic-macos-arm64.tar.gz
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
